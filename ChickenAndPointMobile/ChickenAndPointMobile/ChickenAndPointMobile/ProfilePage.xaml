<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ChickenAndPointMobile.ViewModels"
             xmlns:converters="clr-namespace:ChickenAndPointMobile.Converters"
             x:Class="ChickenAndPointMobile.ProfilePage"
             Title="Профиль"
             BackgroundImageSource="background.png">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
            <converters:StatusToGradientConverter x:Key="StatusGradientConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.BindingContext>
        <vm:ProfilePageViewModel/>
    </ContentPage.BindingContext>

    <Grid RowSpacing="20" Padding="15" BackgroundColor="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Frame Grid.Row="0" CornerRadius="10" Padding="15" HasShadow="True" BackgroundColor="White">
            <StackLayout Spacing="10">
                <Label Text="Мои данные" FontSize="Large" FontAttributes="Bold" TextColor="Black"/>
                <BoxView HeightRequest="1" BackgroundColor="LightGray"/>
                <Grid ColumnSpacing="10" RowSpacing="5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Label Grid.Row="0" Grid.Column="0" Text="Имя:" TextColor="Gray"/>
                    <Label Grid.Row="0" Grid.Column="1" Text="{Binding UserName}" FontAttributes="Bold" TextColor="Black"/>
                    <Label Grid.Row="1" Grid.Column="0" Text="Email:" TextColor="Gray"/>
                    <Label Grid.Row="1" Grid.Column="1" Text="{Binding UserEmail}" TextColor="Black"/>
                </Grid>
            </StackLayout>
        </Frame>

        <StackLayout Grid.Row="1" Spacing="10">
            <Label Text="История заказов" FontSize="Large" FontAttributes="Bold" TextColor="Black"/>
            <BoxView HeightRequest="1" BackgroundColor="LightGray"/>

            <StackLayout IsVisible="{Binding IsBusy}" Padding="20">
                <ActivityIndicator IsRunning="{Binding IsBusy}" Color="OrangeRed"/>
                <Label Text="{Binding LoadingStatus}" HorizontalTextAlignment="Center" TextColor="Gray"/>
            </StackLayout>

            <ListView ItemsSource="{Binding Orders}"
                      HasUnevenRows="True"
                      SelectionMode="None"
                      SeparatorVisibility="None"
                      BackgroundColor="Transparent"
                      CachingStrategy="RetainElement"
                      IsVisible="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}">

                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="vm:OrderHistoryViewModel">
                        <ViewCell>
                            <Frame Margin="0,0,0,10" CornerRadius="12" Padding="0"
                                   HasShadow="True" BackgroundColor="White" IsClippedToBounds="True">
                                <Frame.Background>
                                    <Binding Path="НазваниеСтатуса" Converter="{StaticResource StatusGradientConverter}"/>
                                </Frame.Background>

                                <Grid Padding="15" RowSpacing="8">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <StackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                        <Label Text="{Binding НомерЗаказа, StringFormat='Заказ №{0}'}" FontAttributes="Bold" TextColor="#333" FontSize="Medium"/>
                                        <Label Text="{Binding ВремяСозданияDisplay}" TextColor="#555" FontSize="Small"/>
                                    </StackLayout>

                                    <Label Grid.Row="0" Grid.Column="1" Text="{Binding НазваниеСтатуса}" TextColor="#444" FontAttributes="Bold" VerticalTextAlignment="Start" HorizontalTextAlignment="End"/>

                                    <Label Grid.Row="1" Grid.Column="0" Text="{Binding ИтоговаяСуммаDisplay}" FontSize="Medium" FontAttributes="Bold" TextColor="#333" VerticalOptions="End"/>

                                    <Button Grid.Row="1" Grid.Column="1" Text="Детали"
                                            FontSize="Micro" HeightRequest="30" Padding="10,0"
                                            BackgroundColor="#40000000"
                                            TextColor="White"
                                            BorderColor="Transparent" BorderWidth="0" CornerRadius="15"
                                            VerticalOptions="End" HorizontalOptions="End"
                                            Clicked="OrderDetails_Clicked" CommandParameter="{Binding .}"/>
                                </Grid>
                            </Frame>
                        </ViewCell>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <Label Text="У вас пока нет заказов."
                    IsVisible="{Binding ShowNoOrdersMessage}"
                    HorizontalOptions="Center" TextColor="Gray" Margin="0,20"/>

        </StackLayout>

        <Button Grid.Row="2" Text="Выйти"
                BackgroundColor="WhiteSmoke" TextColor="Gray" BorderColor="LightGray" BorderWidth="1"
                Clicked="LogoutButton_Clicked"
                HorizontalOptions="FillAndExpand" VerticalOptions="End"
                CornerRadius="8"/>

    </Grid>
</ContentPage>